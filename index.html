<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>WP DevPress - WebP Converter</title>
    <style>
      body {
        font-family: "Arial", sans-serif;
        background-color: #f4f4f4;
        margin: 0;
        padding: 0;
        text-align: center;
      }
      .header-container {
        background-color: #283593;
        color: #ffffff;
        padding: 20px 0;
      }
      h1 {
        margin: 10px 0;
        color: #ffffff;
      }
      .upload-section {
        margin: 20px auto;
        width: 80%;
        max-width: 600px;
        background: #ffffff;
        box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
        border-radius: 10px;
        padding: 20px;
      }
      .upload-container {
        border: 2px dashed #283593;
        padding: 20px;
        border-radius: 10px;
      }
      #fileInput {
        display: none;
      }
      button {
        margin: 10px 5px;
        padding: 10px 20px;
        font-size: 16px;
        color: #ffffff;
        background-color: #283593;
        border: none;
        border-radius: 5px;
        cursor: pointer;
      }
      .drag-drop-area {
        margin: 20px 0;
        padding: 40px 20px;
        border: 2px dashed #283593;
        border-radius: 10px;
        cursor: pointer;
      }
      .drag-drop-area.drag-over {
        background-color: #e3f2fd;
      }
      #fileList {
        margin: 20px 0;
        list-style: none;
        padding: 0;
      }
      #fileList li {
        background: #f1f1f1;
        margin: 5px 0;
        padding: 10px;
        border-radius: 5px;
        text-align: left;
      }
    </style>
  </head>

  <body>
    <audio id="imgConverted">
      <source src="./sound/imageConverted.mp3" type="audio/mpeg" />
    </audio>
    <audio id="completed">
      <source src="./sound/convertedCompleted.mp3" type="audio/mpeg" />
    </audio>

    <header>
      <div class="header-container">
        <h1>Convert Images to WebP Format</h1>
        <p>Fast, Free, and Secure!</p>
      </div>
    </header>

    <main>
      <section class="upload-section">
        <div class="upload-container">
          <label id="status">Status</label>
          <h2>Select Images to Convert</h2>
          <input type="file" id="fileInput" multiple />
          <div class="drag-drop-area" id="dragDropArea">
            Drag and drop images here or click to select files
          </div>
          <ul id="fileList"></ul>
          <label for="groupName">Group Name:</label>
          <input type="text" id="groupName" name="groupName">
          <button id="convertButton">Convert to WebP</button>

          <div class="quality-section">
            <label for="quality">Quality:</label>
            <input type="number" id="quality" min="0" max="100" value="80" />%
          </div>
        </div>
      </section>
    </main>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.6.0/jszip.min.js"></script>

    <script>
      const imgConverted = document.getElementById("imgConverted");
      const completed = document.getElementById("completed");
      const groupName = document.getElementById("groupName");

      document
        .getElementById("convertButton")
        .addEventListener("click", async () => {
          const input = document.getElementById("fileInput");
          const quality = document.getElementById("quality").value / 100;

          if (input.files.length === 0) {
            alert("Please select one or more files.");
            return;
          }

          const convertedFiles = [];
          
          for (const file of input.files) {
            const name = file.name.replace(/\.[^.]+$/, "");
            const newName = `${groupName.value.toUpperCase()}-${name}`.replace(/\s+/g, "-");
            document.getElementById("status").innerHTML = `Converted Files: ${convertedFiles.length} of ${input.files.length}`;
            const webpFile = await convertToWebP(file, quality);

            if(webpFile){
              //MOVE CONVERTED FILES TO CATCHER ARRAY
              convertedFiles.push({ webpFile, newName });
              document.getElementById("status").innerHTML = `Converted Files: ${convertedFiles.length} of ${input.files.length}`;
            }

            //MOVE CONVERTED FILES TO CATCHER ARRAY
            // convertedFiles.push({ webpFile, newName });
            imgConverted.play();
          }

          //REVIEW CONVERTED FILES ARRAY TOTAL
          if (convertedFiles.length > 1) {
            const zip = new JSZip();
            convertedFiles.forEach((file) => {
              let f = 0;
              document.getElementById("status").innerHTML = `Zipping Files`;
              zip.file(`${file.newName}.webp`, file.webpFile);
            });
            
            const content = await zip.generateAsync({ type: "blob" });
            const downloadLink = document.createElement("a");
            const url = URL.createObjectURL(content);
            downloadLink.href = url;
            downloadLink.download = "converted_images.zip";
            downloadLink.click();
            URL.revokeObjectURL(url);
            document.getElementById("status").innerHTML = `Completed!`;
            completed.play();
          } else {
            const downloadLink = document.createElement("a");
            const url = URL.createObjectURL(convertedFiles[0].webpFile);
            downloadLink.href = url;
            downloadLink.download = `${convertedFiles[0].newName}.webp`;
            downloadLink.click();
            URL.revokeObjectURL(url);
          }
          input.value = "";
          document.getElementById("fileList").innerHTML = "";
        });

      document
        .getElementById("fileInput")
        .addEventListener("change", (event) => {
          const fileList = document.getElementById("fileList");
          fileList.innerHTML = "";
          for (const file of event.target.files) {
            const li = document.createElement("li");
            li.textContent = file.name;
            fileList.appendChild(li);
          }
        });

      async function convertToWebP(file, quality) {
        return new Promise((resolve, reject) => {
          const reader = new FileReader();
          reader.onload = function (event) {
            const img = new Image();
            img.onload = function () {
              const canvas = document.createElement("canvas");
              canvas.width = img.width;
              canvas.height = img.height;
              const ctx = canvas.getContext("2d");
              ctx.drawImage(img, 0, 0);
              canvas.toBlob(
                (blob) => {
                  resolve(blob);
                },
                "image/webp",
                quality
              );
            };
            img.src = event.target.result;
          };
          reader.readAsDataURL(file);
        });
      }

      const dragDropArea = document.getElementById("dragDropArea");

      dragDropArea.addEventListener("click", () => {
        document.getElementById("fileInput").click();
      });

      dragDropArea.addEventListener("dragover", (event) => {
        event.preventDefault();
        dragDropArea.classList.add("drag-over");
      });

      dragDropArea.addEventListener("dragleave", () => {
        dragDropArea.classList.remove("drag-over");
      });

      dragDropArea.addEventListener("drop", (event) => {
        event.preventDefault();
        dragDropArea.classList.remove("drag-over");
        const files = event.dataTransfer.files;
        document.getElementById("fileInput").files = files;

        const fileList = document.getElementById("fileList");
        fileList.innerHTML = "";
        for (const file of files) {
          const li = document.createElement("li");
          li.textContent = file.name;
          fileList.appendChild(li);
        }
      });
    </script>
  </body>
</html>
